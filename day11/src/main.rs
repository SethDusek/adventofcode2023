use std::collections::{HashMap, HashSet, VecDeque};
use std::cmp;

const INPUT: &'static str = ".#..........#.....................#........................................................#....................................#...........
...................#........................................#......................#........................................................
...........................................#......#..................#...................................................#..................
....#......................#...............................................#.........................#.....#......#................#........
.................................................................#.......................#..................................................
..............................................................................................................................#.............
.......#........#.............#...................................................#...................................#.....................
.........................#...................................#............................................................................#.
....................#.............#.........#..........................................#...............#....................................
.....................................................#...............#.............................................................#........
...........................................................................................................................#................
..........................................................#.........................................#...............#.......................
..............................................................................................#.............................................
.#........#........................#......#..............................................#..............................#...............#...
...............#......#...............................#.......#.........#......#.............................#.................#............
...............................#..............#.............................................................................................
............................................................................................................................................
.........................#.......................................#..........................................................................
..................#........................#......................................#........................................#................
..................................................#.......#..............................................#........................#.......#.
...#........#........................#....................................#...............#.................................................
............................................................................................................................................
.......#........................#....................................................................................#......................
...............#...........#........................................................................#.......................................
.............................................#................#.........#.............................................................#.....
...........#...........................#................#...........................#.......................................................
..................................................#.......................................#.............#...................................
.....#..................#..........#..............................#.............................#........................................#..
..............................#...............................................................................................#.............
...................................................................................................................#........................
..............#..........................................#.............#...........................#..............................#.........
...#...................................#.........................................#..........................................................
..................#...................................................................#................................................#....
..........................#...................................#.........................................#...................................
............................................................................................................................................
.........#...........#..........#..........................................#....................#..............#........#.....#...........#.
....................................................#.......................................................................................
.............................................#..............................................................................................
......................................#..................#..............................#...........#.......#...............................
............................#..................................#..............#.............................................................
...............#............................................................................................................................
...........................................#............................#.......................#...........................................
.....#..............#.................................................................................#...........................#.........
............................................................................................................................................
........................................#..........#.................#..........................................#...........................
.............................................#.................................#...........#................................................
...............................#.......................#...........................................#.......#....................#...........
#........#.............#...............................................................................................#...................#
.....................................#........................#..........#.........#........................................................
.................#............................................................................#.............................................
..........................#.......................................#.................................................#.......................
.....................................................#...................................#....................................#.............
..#.........................................................................................................................................
.............#.....#.......................#.............#....................................................#........................#....
......#........................................................................................#............................................
.................................#.................................#........................................................................
.................................................................................#.......................#................................#.
#.....................................................#...................................................................#.....#...........
.........#..................................................#......................................#........................................
..............................#.............#.................................................................#.......#.....................
........................#............................................................#......#................................#..............
.............#..............................................................................................................................
.....#........................................................#............#..........................#...........................#.........
...........................#......#.................................................................................#...................#...
.........#.....................................#...............................#............................................................
..................#.......................................#.......#................................#........................................
...............................#.....................#...................................#................................#.................
..............#..........................#.............................#............#.....................#.....................#.........#.
.................................................................................................................#..........................
......#.....................................................................................................................................
...........#.............#.........#........................................................................................................
...................................................................#..............#..................#......................................
..................#...........................................................................................#.............................
........#.................................#..............#.................................................................#..........#.....
...#.....................................................................#..............#.......#...........................................
............................................................................................................................................
............................................................................................................................................
.................................#................#..........................................................#...............#.............#
..............#............................................................#................................................................
......#.....................#..........................#........#.....#............#..............#.........................................
....................#..................................................................................#..................#.................
....................................#.........#........................................................................................#....
..........................................................#..............#..................................................................
................#...............................................................................................#.............#.............
............................................................................................................................................
............................#...................#......#.............#..............................................#.......................
.............#...................................................................................#........................................#.
......................#..........................................................#.......#..................................................
#...........................................................#...............................................................................
.........#.........................#.................#....................................................#.................#...............
............................................................................................................................................
...................#.............................................#.....#....................................................................
........................#.........................#.....................................................................................#...
.....#........................................................................................................................#.............
.......................................#...............................................................#.........#..........................
............................#...........................#...........#......................#..............................#.......#.........
..#................................#...........#............................................................................................
.................#..................................#...................#...................................................................
..........#.................................................#................................................#..............................
.....................#...............................................................................#......................................
..............#..................#..............................#.............#....................................#.........#........#.....
...#.............................................................................................#..........................................
............................................#..........................................#....................................................
.........#...............................................#..............................................................#...................
................#.........#.................................................................................................................
.....#..................................#............................#..............................#........#..................#..........#
...............................#............................................................................................................
....................................................#........#..............................................................................
........#..........................#.........#...............................................................................#..............
....................................................................................................................#.......................
....................#........#......................................#.........#.....#.....#.................................................
................................................................................................................................#.....#.....
...............#..........................................#...............#...............................#.................................
...#..............................#.........................................................................................................
........................................................................................#............#....................................#.
............................................................................................................................#...............
...................................................................................#............................#...........................
#........#........#........#..........#.........#...........................................................................................
.............................................................#..............................#............................#..................
................................#.......................#...................................................................................
.......................#................................................#...............#.........#..................#................#.....
............#..................................................................#........................#...................................
............................................................................................................................................
......#.....................#.......#......#..............#......#..........................................................................
.....................#......................................................................................................................
................................#................................................#.............#...........................#.............#..
..............................................................................................................#.............................
............#............#..........................................................................#.............................#.........
.....#...........#.....................#.............................#.....#........................................#.......................
................................................#...........#..........................#....................................................
............................................................................................................................................
#..........................#.....#................................................................#......................................#..
..........................................#.................................................................#.............#.................
................#.........................................................#.................................................................
.......#..............................#..............................................#..........................................#...........
........................#...................................#...............................................................................
............................................................................................................................#...............
..............................#.....................#.............................#...........#.................#...........................
...............................................#................#.....#................................................#....................
...................#...................#.................#.................#.........................#......................................
";
const TEST: &'static str = "...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....
";

fn run(input: &'static str) {
    let len = input.lines().next().unwrap().len();
    let mut empty = String::new();
    let mut replacement = String::new();
    for _ in 0..len {
        empty.push('.');
        replacement.push('.');
    }
    replacement.push('\n');
    for _ in 0..len {
        replacement.push('.');
    }
    let input = input.replace(&empty, &replacement);
    print!("{input}");
    let mut lines = input.lines().map(String::from).collect::<Vec<String>>();
    let mut i = 0;
    while i < lines[0].len() {
        let mut all = true;
        for r in 0..lines.len() {
            if lines[r].bytes().nth(i).unwrap() != b'.' {
                all = false;
            }
        }
        if all {
            for r in 0..lines.len() {
                lines[r].insert(i, '.');
            }
            i+=1;
        }
        i+=1;
    }
    print!("{:?}", lines);
    let grid: HashMap<(i64, i64), char> =
        lines.into_iter()
        .enumerate()
        .flat_map(|(y, l)| {
            l.chars().collect::<Vec<char>>().into_iter()
                .enumerate()
                .map(move |(x, c)| ((y as i64, x as i64), c as char))
        })
        .collect();
    let adj = [
        (-1, 0),
        (0, -1),
        (0, 1),
        (1, 0),
    ];

    let galaxies = grid.iter().filter(|(_, v)| **v == '#').map(|(&k, &v)| k).collect::<HashSet<(i64, i64)>>();

    let mut pairs: HashSet<((i64, i64), (i64, i64))> = HashSet::new();
    let mut total = 0;
    for galaxy in &galaxies {
        let mut queue = VecDeque::new();
        let mut visited = HashSet::new();
        queue.push_back((*galaxy, 0));
        while queue.len() != 0 {
            let (coord, depth) = queue.pop_front().unwrap();
            if visited.contains(&coord) {
                continue;
            }
            visited.insert(coord);
            if galaxies.contains(&coord) && coord != *galaxy && !pairs.contains(&(cmp::min(coord, *galaxy), cmp::max(coord, *galaxy))) {
                pairs.insert((cmp::min(coord, *galaxy), cmp::max(coord, *galaxy)));
                //println!("From galaxy {:?} to {:?} = {} steps", galaxy, coord, depth);
                total += depth;
            }
            for adjacent in &adj {
                let new_pos = (coord.0 + adjacent.0, coord.1 + adjacent.1);
                if !grid.contains_key(&new_pos) || visited.contains(&new_pos) {
                    continue;
                }
                queue.push_back((new_pos, depth + 1));
            }
        }
    }
    //println!("{:?}, {}", pairs, pairs.len());
    print!("{}", total);
}
fn main() {
    run(TEST);

    run(INPUT);
}
