use std::collections::{HashMap, HashSet, VecDeque};
use std::cmp;

const INPUT: &'static str = ".#..........#.....................#........................................................#....................................#...........
...................#........................................#......................#........................................................
...........................................#......#..................#...................................................#..................
....#......................#...............................................#.........................#.....#......#................#........
.................................................................#.......................#..................................................
..............................................................................................................................#.............
.......#........#.............#...................................................#...................................#.....................
.........................#...................................#............................................................................#.
....................#.............#.........#..........................................#...............#....................................
.....................................................#...............#.............................................................#........
...........................................................................................................................#................
..........................................................#.........................................#...............#.......................
..............................................................................................#.............................................
.#........#........................#......#..............................................#..............................#...............#...
...............#......#...............................#.......#.........#......#.............................#.................#............
...............................#..............#.............................................................................................
............................................................................................................................................
.........................#.......................................#..........................................................................
..................#........................#......................................#........................................#................
..................................................#.......#..............................................#........................#.......#.
...#........#........................#....................................#...............#.................................................
............................................................................................................................................
.......#........................#....................................................................................#......................
...............#...........#........................................................................#.......................................
.............................................#................#.........#.............................................................#.....
...........#...........................#................#...........................#.......................................................
..................................................#.......................................#.............#...................................
.....#..................#..........#..............................#.............................#........................................#..
..............................#...............................................................................................#.............
...................................................................................................................#........................
..............#..........................................#.............#...........................#..............................#.........
...#...................................#.........................................#..........................................................
..................#...................................................................#................................................#....
..........................#...................................#.........................................#...................................
............................................................................................................................................
.........#...........#..........#..........................................#....................#..............#........#.....#...........#.
....................................................#.......................................................................................
.............................................#..............................................................................................
......................................#..................#..............................#...........#.......#...............................
............................#..................................#..............#.............................................................
...............#............................................................................................................................
...........................................#............................#.......................#...........................................
.....#..............#.................................................................................#...........................#.........
............................................................................................................................................
........................................#..........#.................#..........................................#...........................
.............................................#.................................#...........#................................................
...............................#.......................#...........................................#.......#....................#...........
#........#.............#...............................................................................................#...................#
.....................................#........................#..........#.........#........................................................
.................#............................................................................#.............................................
..........................#.......................................#.................................................#.......................
.....................................................#...................................#....................................#.............
..#.........................................................................................................................................
.............#.....#.......................#.............#....................................................#........................#....
......#........................................................................................#............................................
.................................#.................................#........................................................................
.................................................................................#.......................#................................#.
#.....................................................#...................................................................#.....#...........
.........#..................................................#......................................#........................................
..............................#.............#.................................................................#.......#.....................
........................#............................................................#......#................................#..............
.............#..............................................................................................................................
.....#........................................................#............#..........................#...........................#.........
...........................#......#.................................................................................#...................#...
.........#.....................................#...............................#............................................................
..................#.......................................#.......#................................#........................................
...............................#.....................#...................................#................................#.................
..............#..........................#.............................#............#.....................#.....................#.........#.
.................................................................................................................#..........................
......#.....................................................................................................................................
...........#.............#.........#........................................................................................................
...................................................................#..............#..................#......................................
..................#...........................................................................................#.............................
........#.................................#..............#.................................................................#..........#.....
...#.....................................................................#..............#.......#...........................................
............................................................................................................................................
............................................................................................................................................
.................................#................#..........................................................#...............#.............#
..............#............................................................#................................................................
......#.....................#..........................#........#.....#............#..............#.........................................
....................#..................................................................................#..................#.................
....................................#.........#........................................................................................#....
..........................................................#..............#..................................................................
................#...............................................................................................#.............#.............
............................................................................................................................................
............................#...................#......#.............#..............................................#.......................
.............#...................................................................................#........................................#.
......................#..........................................................#.......#..................................................
#...........................................................#...............................................................................
.........#.........................#.................#....................................................#.................#...............
............................................................................................................................................
...................#.............................................#.....#....................................................................
........................#.........................#.....................................................................................#...
.....#........................................................................................................................#.............
.......................................#...............................................................#.........#..........................
............................#...........................#...........#......................#..............................#.......#.........
..#................................#...........#............................................................................................
.................#..................................#...................#...................................................................
..........#.................................................#................................................#..............................
.....................#...............................................................................#......................................
..............#..................#..............................#.............#....................................#.........#........#.....
...#.............................................................................................#..........................................
............................................#..........................................#....................................................
.........#...............................................#..............................................................#...................
................#.........#.................................................................................................................
.....#..................................#............................#..............................#........#..................#..........#
...............................#............................................................................................................
....................................................#........#..............................................................................
........#..........................#.........#...............................................................................#..............
....................................................................................................................#.......................
....................#........#......................................#.........#.....#.....#.................................................
................................................................................................................................#.....#.....
...............#..........................................#...............#...............................#.................................
...#..............................#.........................................................................................................
........................................................................................#............#....................................#.
............................................................................................................................#...............
...................................................................................#............................#...........................
#........#........#........#..........#.........#...........................................................................................
.............................................................#..............................#............................#..................
................................#.......................#...................................................................................
.......................#................................................#...............#.........#..................#................#.....
............#..................................................................#........................#...................................
............................................................................................................................................
......#.....................#.......#......#..............#......#..........................................................................
.....................#......................................................................................................................
................................#................................................#.............#...........................#.............#..
..............................................................................................................#.............................
............#............#..........................................................................#.............................#.........
.....#...........#.....................#.............................#.....#........................................#.......................
................................................#...........#..........................#....................................................
............................................................................................................................................
#..........................#.....#................................................................#......................................#..
..........................................#.................................................................#.............#.................
................#.........................................................#.................................................................
.......#..............................#..............................................#..........................................#...........
........................#...................................#...............................................................................
............................................................................................................................#...............
..............................#.....................#.............................#...........#.................#...........................
...............................................#................#.....#................................................#....................
...................#...................#.................#.................#.........................#......................................
";
const TEST: &'static str = "...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....
";

fn run(input: &'static str, dist: usize) {
    let empty_rows = input.lines().enumerate().filter(|(_, l)| l.chars().all(|c| c == '.')).map(|(i, _)| i as i64).collect::<HashSet<i64>>();
    let mut empty_cols = HashSet::new();
    let mut lines = input.lines().collect::<Vec<&str>>();
    for i in 0..lines[0].len() {
        let mut all = true;
        for r in 0..lines.len() {
            if lines[r].bytes().nth(i).unwrap() != b'.' { all = false; }
        }
        if all { empty_cols.insert(i as i64); }
    }
    println!("{:?} {:?}", empty_rows, empty_cols);
    let grid: HashMap<(i64, i64), char> =
        input.lines()
        .enumerate()
        .flat_map(|(y, l)| {
            l.chars()
                .enumerate()
                .map(move |(x, c)| ((y as i64, x as i64), c as char))
        })
        .collect();
    let adj = [
        (-1, 0),
        (0, -1),
        (0, 1),
        (1, 0),
    ];

    let galaxies = grid.iter().filter(|(_, v)| **v == '#').map(|(&k, &v)| k).collect::<HashSet<(i64, i64)>>();

    let mut pairs: HashSet<((i64, i64), (i64, i64))> = HashSet::new();
    let mut total = 0;
    for galaxy in &galaxies {
        let mut queue = VecDeque::new();
        let mut visited = HashSet::new();
        queue.push_back((*galaxy, 0));
        while queue.len() != 0 {
            let (coord, depth) = queue.pop_front().unwrap();
            if visited.contains(&coord) {
                continue;
            }
            visited.insert(coord);
            if galaxies.contains(&coord) && coord != *galaxy && !pairs.contains(&(cmp::min(coord, *galaxy), cmp::max(coord, *galaxy))) {
                pairs.insert((cmp::min(coord, *galaxy), cmp::max(coord, *galaxy)));
                //println!("From galaxy {:?} to {:?} = {} steps", galaxy, coord, depth);
                total += depth;
            }
            for adjacent in &adj {
                let mut new_pos = (coord.0 + adjacent.0, coord.1 + adjacent.1);
                let mut distance = 1;


                while empty_rows.contains(&new_pos.0) {
                    distance += dist;
                    new_pos.0 += adjacent.0;
                }
                while empty_cols.contains(&new_pos.1) {
                    distance+=dist;
                    new_pos.1 += adjacent.1;
                }
                if !grid.contains_key(&new_pos) || visited.contains(&new_pos) {
                    continue;
                }
                queue.push_back((new_pos, depth + distance));
            }
        }
    }
    //println!("{:?}, {}", pairs, pairs.len());
    print!("{}", total);
}
fn main() {
    run(TEST, 1_000_000);

    run(INPUT, 1_000_000);
}
